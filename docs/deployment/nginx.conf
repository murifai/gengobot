# Nginx Configuration for GengoBot
#
# Architecture:
# - gengobot.com (www.gengobot.com) -> WordPress (landing page, blog, changelog)
# - app.gengobot.com -> Next.js application
#
# Installation:
# 1. Copy this file to /etc/nginx/sites-available/gengobot
# 2. Replace 'gengobot.com' with your actual domain
# 3. Create symlink: sudo ln -s /etc/nginx/sites-available/gengobot /etc/nginx/sites-enabled/
# 4. Test config: sudo nginx -t
# 5. Reload Nginx: sudo systemctl reload nginx

# ============================================
# RATE LIMITING ZONES
# ============================================
limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;
limit_req_zone $binary_remote_addr zone=general_limit:10m rate=30r/s;
limit_req_zone $binary_remote_addr zone=wp_limit:10m rate=5r/s;
limit_conn_zone $binary_remote_addr zone=addr:10m;

# ============================================
# UPSTREAM SERVERS
# ============================================

# Next.js application (app.gengobot.com)
upstream nextjs_upstream {
    server 127.0.0.1:3000;
    keepalive 64;
}

# PHP-FPM for WordPress (gengobot.com)
upstream php_upstream {
    server unix:/run/php/php8.2-fpm.sock;
}

# ============================================
# MAIN DOMAIN: gengobot.com (WordPress)
# ============================================

# HTTP to HTTPS redirect for main domain
server {
    listen 80;
    listen [::]:80;
    server_name gengobot.com www.gengobot.com;

    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    location / {
        return 301 https://gengobot.com$request_uri;
    }
}

# Redirect www to non-www
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name www.gengobot.com;

    # SSL (configured by Certbot)
    ssl_certificate /etc/letsencrypt/live/gengobot.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/gengobot.com/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    return 301 https://gengobot.com$request_uri;
}

# HTTPS server for WordPress (gengobot.com)
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name gengobot.com;

    # SSL Configuration
    ssl_certificate /etc/letsencrypt/live/gengobot.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/gengobot.com/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    # WordPress root directory
    root /var/www/wordpress;
    index index.php index.html;

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

    # Logging
    access_log /var/log/nginx/wordpress-access.log combined;
    error_log /var/log/nginx/wordpress-error.log warn;

    # Gzip compression
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/json
        application/javascript
        application/xml+rss
        image/svg+xml;

    # Client body size (for WordPress uploads)
    client_max_body_size 64M;

    # Rate limiting
    limit_req zone=wp_limit burst=20 nodelay;
    limit_conn addr 10;

    # WordPress permalinks
    location / {
        try_files $uri $uri/ /index.php?$args;
    }

    # PHP handling
    location ~ \.php$ {
        try_files $uri =404;
        fastcgi_split_path_info ^(.+\.php)(/.+)$;
        fastcgi_pass php_upstream;
        fastcgi_index index.php;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param PATH_INFO $fastcgi_path_info;
        fastcgi_read_timeout 300;
    }

    # Static assets caching
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 30d;
        add_header Cache-Control "public, immutable";
        log_not_found off;
    }

    # WordPress security - deny access to sensitive files
    location ~ /\.ht {
        deny all;
    }

    location ~ /wp-config\.php {
        deny all;
    }

    location ~ /xmlrpc\.php {
        deny all;
    }

    location ~* /wp-includes/.*\.php$ {
        deny all;
    }

    location ~* /wp-content/uploads/.*\.php$ {
        deny all;
    }

    # Deny hidden files
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }
}

# ============================================
# APP SUBDOMAIN: app.gengobot.com (Next.js)
# ============================================

# HTTP to HTTPS redirect for app subdomain
server {
    listen 80;
    listen [::]:80;
    server_name app.gengobot.com;

    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    location / {
        return 301 https://app.gengobot.com$request_uri;
    }
}

# HTTPS server for Next.js app (app.gengobot.com)
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name app.gengobot.com;

    # SSL Configuration
    ssl_certificate /etc/letsencrypt/live/app.gengobot.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/app.gengobot.com/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

    # Logging
    access_log /var/log/nginx/gengobot-app-access.log combined;
    error_log /var/log/nginx/gengobot-app-error.log warn;

    # Gzip compression (includes audio types)
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/json
        application/javascript
        application/xml+rss
        application/rss+xml
        font/truetype
        font/opentype
        application/vnd.ms-fontobject
        image/svg+xml
        audio/mpeg
        audio/mp3
        audio/ogg
        audio/wav
        audio/webm
        audio/aac
        audio/flac;

    # Client body size (for audio file uploads)
    client_max_body_size 25M;
    client_body_buffer_size 128k;

    # Default timeouts (extended for streaming/audio)
    proxy_connect_timeout 300s;
    proxy_send_timeout 300s;
    proxy_read_timeout 300s;
    send_timeout 300s;

    # Connection limits
    limit_conn addr 20;

    # ============================================
    # AUDIO/VOICE API ROUTES - Special Configuration
    # ============================================
    location ~ ^/api/voice/(synthesize|transcribe) {
        limit_req zone=api_limit burst=30 nodelay;
        limit_req_status 429;

        proxy_pass http://nextjs_upstream;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;

        # CRITICAL: Disable buffering for audio streaming
        proxy_buffering off;
        proxy_request_buffering off;

        # Extended timeouts for TTS generation
        proxy_connect_timeout 120s;
        proxy_send_timeout 120s;
        proxy_read_timeout 120s;

        add_header Accept-Ranges bytes;
    }

    # Whisper transcription endpoint
    location /api/whisper/ {
        limit_req zone=api_limit burst=20 nodelay;

        proxy_pass http://nextjs_upstream;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_buffering off;
        proxy_request_buffering off;
        client_max_body_size 25M;

        proxy_connect_timeout 120s;
        proxy_send_timeout 120s;
        proxy_read_timeout 120s;
    }

    # ============================================
    # STREAMING API ROUTES - SSE/Streaming
    # ============================================
    location ~ ^/api/(task-attempts|free-conversation)/.*/(stream|transcribe-stream) {
        proxy_pass http://nextjs_upstream;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;

        # CRITICAL: Disable buffering for SSE streaming
        proxy_buffering off;
        proxy_cache off;
        chunked_transfer_encoding on;

        proxy_read_timeout 3600s;
        proxy_send_timeout 3600s;

        add_header Cache-Control "no-cache, no-store, must-revalidate";
        add_header X-Accel-Buffering "no";
    }

    # ============================================
    # WEBHOOK ROUTES - No rate limiting
    # ============================================
    location /api/webhooks/ {
        proxy_pass http://nextjs_upstream;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # ============================================
    # STANDARD API ROUTES
    # ============================================
    location /api/ {
        limit_req zone=api_limit burst=20 nodelay;
        limit_req_status 429;

        proxy_pass http://nextjs_upstream;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    # ============================================
    # STATIC ASSETS
    # ============================================
    location /_next/static {
        proxy_pass http://nextjs_upstream;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;

        expires 365d;
        add_header Cache-Control "public, immutable";
    }

    location /_next/image {
        proxy_pass http://nextjs_upstream;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;

        expires 30d;
        add_header Cache-Control "public";
    }

    location /images/ {
        proxy_pass http://nextjs_upstream;
        expires 30d;
        add_header Cache-Control "public";
    }

    location /fonts/ {
        proxy_pass http://nextjs_upstream;
        expires 365d;
        add_header Cache-Control "public, immutable";
    }

    location ~ ^/(favicon\.ico|robots\.txt|sitemap\.xml) {
        proxy_pass http://nextjs_upstream;
        expires 7d;
        add_header Cache-Control "public";
    }

    # ============================================
    # MAIN APPLICATION
    # ============================================
    location / {
        limit_req zone=general_limit burst=50 nodelay;

        proxy_pass http://nextjs_upstream;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_buffering off;
    }

    # Deny hidden files
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }
}
