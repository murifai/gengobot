// Prisma schema for Gengotalk - Task-Based Japanese Learning App
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Task model - Primary feature for structured learning
model Task {
  id                 String   @id @default(cuid())
  title              String
  description        String   @db.Text
  category           String // Restaurant, Shopping, Travel, etc.
  subcategoryId      String? // Reference to TaskSubcategory
  difficulty         String // N1-N5 JLPT levels
  scenario             String @db.Text
  learningObjectives   Json // Array of learning goals
  conversationExample  String @db.Text // Example conversation dialog (T: teacher, G: student)
  estimatedDuration    Int // Minutes
  maxMessages        Int      @default(30) // Maximum messages per attempt
  isActive           Boolean  @default(true)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  createdBy          String? // Admin who created the task
  usageCount         Int      @default(0)
  averageScore       Float? // Average completion score

  // Voice settings (replaces characterId)
  prompt        String  @default("") @db.Text // AI system prompt for the task
  voice         String  @default("alloy") // OpenAI TTS voice
  speakingSpeed Float   @default(1.0) // Voice speed (0.25 - 4.0)
  audioExample  String? // Path to example audio file

  subcategory   TaskSubcategory? @relation(fields: [subcategoryId], references: [id])
  conversations Conversation[]
  taskAttempts  TaskAttempt[]
  studyDecks    TaskDeck[]

  @@index([category])
  @@index([subcategoryId])
  @@index([difficulty])
  @@index([isActive])
}

// TaskDeck model - Join table for Task-Deck many-to-many relationship
model TaskDeck {
  id        String   @id @default(cuid())
  taskId    String
  deckId    String
  order     Int      @default(0) // Display order for multiple decks
  createdAt DateTime @default(now())

  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  deck Deck @relation(fields: [deckId], references: [id], onDelete: Cascade)

  @@unique([taskId, deckId])
  @@index([taskId])
  @@index([deckId])
}

// TaskAttempt model - Tracks user progress on tasks
model TaskAttempt {
  id        String    @id @default(cuid())
  userId    String
  taskId    String
  startTime DateTime  @default(now())
  endTime   DateTime?

  // Simplified Feedback System
  feedback                  String?  @db.Text // JSON: SimplifiedAssessment
  conversationHistory       Json                // { messages: [...] }
  isCompleted               Boolean  @default(false)
  retryCount                Int      @default(0)

  // Objective Tracking
  objectiveCompletionStatus Json?               // ObjectiveTracking[]
  totalMessages             Int      @default(0)
  completionDuration        Int?                // seconds
  completionSuggestedAt     DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([taskId])
  @@index([isCompleted])
}

// TaskCategory model - Main categories for tasks
model TaskCategory {
  id        String   @id @default(cuid())
  name      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  subcategories TaskSubcategory[]
}

// TaskSubcategory model - Subcategories for tasks (Jalan-jalan, Keseharian, Pekerjaan)
model TaskSubcategory {
  id         String   @id @default(cuid())
  name       String
  categoryId String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  category TaskCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  tasks    Task[]

  @@unique([name, categoryId])
  @@index([categoryId])
}

// User model - Student and admin accounts
model User {
  id                      String    @id @default(cuid())
  email                   String    @unique
  emailVerified           DateTime?
  name                    String?
  password                String? // Hashed password for credentials auth
  image                   String?
  proficiency             String    @default("N5") // N1-N5 JLPT levels
  isAdmin                 Boolean   @default(false)
  preferredTaskCategories Json? // Array of preferred task types
  completedTasks          Json? // Array of completed task IDs
  currentTaskId           String? // Currently active task
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt

  // Profile fields
  fullName                String?   // Nama Lengkap
  nickname                String?   // Nama Panggilan
  domicile                String?   // Domisili
  institution             String?   // Institusi
  subscriptionPlan        String    @default("free") // free, premium

  // Onboarding fields
  onboardingCompleted     Boolean   @default(false)
  ageRange                String?   // "10-19", "20-29", "30-39", "40-49", "50+"
  gender                  String?   // "male", "female"
  learningDuration        String?   // Duration of Japanese study
  learningGoals           Json?     // Array of learning goals
  japaneseUsageOpportunities Json?  // Array of usage opportunities
  hasAppExperience        Boolean?  // Has used Japanese learning apps
  previousApps            String?   // Names of previous apps used
  conversationPracticeExp String?   // Frequency of conversation practice
  appOpinion              String?   @db.Text // Opinion about previous apps
  hasLivedInJapan         Boolean?  // Has lived in Japan
  japanStayDuration       String?   // Duration of stay in Japan

  accounts           Account[]
  sessions           Session[]
  characters         Character[]
  conversations      Conversation[]
  taskAttempts       TaskAttempt[]
  adminLogs          AdminLog[]
  decks              Deck[]
  studySessions      StudySession[]
  freeConversations  FreeConversation[]
  analyticsEvents    AnalyticsEvent[]
  subscription       Subscription?
  creditTransactions CreditTransaction[]
  voucherRedemptions VoucherRedemption[]
  pendingPayments    PendingPayment[]
  notifications      Notification[]
  trialHistory       TrialHistory?
  favoriteDecks      UserFavorite[]
  studyingDecks      UserStudyingDeck[]
  extensionToken     ExtensionToken?

  @@index([email])
  @@index([isAdmin])
}

// Admin model - Separate admin authentication (email/password)
model Admin {
  id        String    @id @default(cuid())
  email     String    @unique
  password  String    // Hashed password
  name      String
  role      AdminRole @default(ADMIN)
  isActive  Boolean   @default(true)
  lastLogin DateTime?

  // Password reset
  resetToken       String?
  resetTokenExpiry DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
  @@index([role])
  @@index([isActive])
}

enum AdminRole {
  SUPER_ADMIN
  ADMIN
  VIEWER
}

// NextAuth Account model
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

// NextAuth Session model
model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// NextAuth Verification Token model (for magic link auth)
model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// Email Verification Token model (for email verification)
model EmailVerificationToken {
  id         String   @id @default(cuid())
  email      String
  token      String   @unique
  expires    DateTime
  createdAt  DateTime @default(now())
  verifiedAt DateTime?

  @@index([email])
  @@index([token])
}

// Password Reset Token model (for password reset)
model PasswordResetToken {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expires   DateTime
  createdAt DateTime @default(now())
  usedAt    DateTime?

  @@index([email])
  @@index([token])
}

// Character model - For free-chat scenarios
model Character {
  id                 String  @id @default(cuid())
  name               String  // Stored in Katakana/Kanji
  nameRomaji         String? // Original romaji input for reference
  description        String? @db.Text
  avatar             String? // Avatar image URL
  voice              String  @default("alloy") // OpenAI TTS voice
  speakingStyle      String? @db.Text // Replaces personality traits
  relationshipType   String  @default("teman") // teman, guru, atasan, pacar, keluarga, lainnya
  relationshipCustom String? // For custom "lainnya" input
  isUserCreated      Boolean @default(true)

  userId             String?
  user               User?               @relation(fields: [userId], references: [id], onDelete: Cascade)
  conversations      Conversation[]
  freeConversations  FreeConversation[]

  @@index([userId])
}

// Conversation model - Stores chat histories
model Conversation {
  id          String   @id @default(cuid())
  type        String // "task-based" or "free-chat"
  messages    Json
  assessment  Json?
  taskId      String? // Associated task (if task-based)
  characterId String? // Character involved
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  userId    String
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  character Character? @relation(fields: [characterId], references: [id], onDelete: Cascade)
  task      Task?      @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([type])
  @@index([taskId])
}

// AdminLog model - Track admin actions for auditing
model AdminLog {
  id         String   @id @default(cuid())
  adminId    String
  actionType String // create_task, edit_task, delete_task, etc.
  entityType String // task, character, user, etc.
  entityId   String?
  details    Json?
  createdAt  DateTime @default(now())

  admin User @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@index([adminId])
  @@index([actionType])
  @@index([createdAt])
}

// Deck model - Collections of flashcards for study
model Deck {
  id          String  @id @default(cuid())
  name        String
  description String? @db.Text
  isPublic    Boolean @default(false)
  category    String? // Kanji, Vocabulary, Grammar, Mixed, Hiragana, Katakana, etc.
  difficulty  String? // N1-N5 JLPT levels, or "unspecified" for non-JLPT content

  // Share feature
  shareToken String? @unique // Unique token for shareable links

  // Analytics
  totalCards   Int    @default(0)
  studyCount   Int    @default(0) // Number of times studied
  averageScore Float? // Average performance across all studies

  // Ownership
  createdBy  String
  isActive   Boolean  @default(true)
  isTaskDeck Boolean  @default(false) // Deck intended for task prerequisites
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  creator       User              @relation(fields: [createdBy], references: [id], onDelete: Cascade)
  flashcards    Flashcard[]
  studySessions StudySession[]
  taskDecks     TaskDeck[]
  favorites     UserFavorite[]
  studyingUsers UserStudyingDeck[]

  @@index([createdBy])
  @@index([category])
  @@index([difficulty])
  @@index([isActive])
  @@index([isPublic])
  @@index([shareToken])
}

// Flashcard model - Individual study cards with spaced repetition
model Flashcard {
  id     String @id @default(cuid())
  deckId String

  // Card type determines which fields are used
  cardType String // "kanji", "vocabulary", "grammar", "hiragana", "katakana"

  // Hiragana/Katakana Card Fields
  character String? // The kana character (あ, ア, etc.)
  romaji    String? // Romanized reading (a, ka, etc.)
  strokeSvg String? @db.Text // KanjiVG SVG data for stroke animation

  // Kanji Card Fields
  kanji        String?
  kanjiMeaning String? @db.Text
  onyomi       String?
  kunyomi      String?

  // Vocabulary Card Fields
  word         String?
  wordMeaning  String? @db.Text
  reading      String? // Furigana/pronunciation
  partOfSpeech String? // Noun, Verb, Adjective, etc.

  // Grammar Card Fields
  grammarPoint   String? @db.Text
  grammarMeaning String? @db.Text
  usageNote      String? @db.Text

  // Common Fields (all card types)
  exampleSentence    String? @db.Text
  exampleTranslation String? @db.Text
  notes              String? @db.Text
  tags               Json? // Array of tags for filtering

  // Audio Fields (optional upload, fallback to Web Speech API)
  audioUrl        String? // Main pronunciation audio URL
  exampleAudioUrl String? // Example sentence audio URL

  // Spaced Repetition Algorithm (SM-2)
  easeFactor     Float     @default(2.5) // Difficulty rating
  interval       Int       @default(0) // Days until next review
  repetitions    Int       @default(0) // Number of successful reviews
  nextReviewDate DateTime? // When to review next
  lastReviewedAt DateTime? // Last review timestamp

  // Order and status
  position  Int      @default(0) // Order within deck
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  deck          Deck              @relation(fields: [deckId], references: [id], onDelete: Cascade)
  reviewHistory FlashcardReview[]

  @@index([deckId])
  @@index([cardType])
  @@index([nextReviewDate])
  @@index([isActive])
}

// FlashcardReview model - Track individual card review history
model FlashcardReview {
  id          String @id @default(cuid())
  flashcardId String
  sessionId   String

  // Review outcome
  rating       String // "belum_hafal", "hafal"
  responseTime Int? // Milliseconds

  // Spaced repetition data at time of review
  easeFactor Float
  interval   Int

  reviewedAt DateTime @default(now())

  flashcard Flashcard    @relation(fields: [flashcardId], references: [id], onDelete: Cascade)
  session   StudySession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([flashcardId])
  @@index([sessionId])
  @@index([reviewedAt])
}

// StudySession model - Track study session performance
model StudySession {
  id     String @id @default(cuid())
  userId String
  deckId String

  // Session metrics
  cardsReviewed       Int    @default(0)
  cardsCorrect        Int    @default(0)
  averageResponseTime Float? // Milliseconds

  // Session breakdown by rating
  belumHafalCount Int @default(0)
  hafalCount      Int @default(0)

  // Progress tracking for resume functionality
  currentCardIndex Int     @default(0) // Current position in the deck
  cardOrder        Json?   // Array of flashcard IDs in study order
  reviewedCardIds  Json?   // Array of already reviewed card IDs

  startTime   DateTime  @default(now())
  endTime     DateTime?
  isCompleted Boolean   @default(false)

  user    User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  deck    Deck              @relation(fields: [deckId], references: [id], onDelete: Cascade)
  reviews FlashcardReview[]

  @@index([userId])
  @@index([deckId])
  @@index([startTime])
  @@index([isCompleted])
}

// UserFavorite model - Track user's favorite decks
model UserFavorite {
  id        String   @id @default(cuid())
  userId    String
  deckId    String
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  deck Deck @relation(fields: [deckId], references: [id], onDelete: Cascade)

  @@unique([userId, deckId])
  @@index([userId])
  @@index([deckId])
}

// UserStudyingDeck model - Track decks user is currently studying
model UserStudyingDeck {
  id          String   @id @default(cuid())
  userId      String
  deckId      String
  lastStudied DateTime @default(now())
  createdAt   DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  deck Deck @relation(fields: [deckId], references: [id], onDelete: Cascade)

  @@unique([userId, deckId])
  @@index([userId])
  @@index([deckId])
  @@index([lastStudied])
}

// FreeConversation model - Free conversation sessions (Kaiwa Bebas)
model FreeConversation {
  id                  String   @id @default(cuid())
  userId              String
  characterId         String? // Character for this conversation (optional for migration)
  startTime           String // ISO DateTime as string
  endTime             String? // ISO DateTime as string
  conversationHistory Json // { messages: [], startedAt: string }
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  character Character? @relation(fields: [characterId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([characterId])
  @@index([createdAt])
}

// Analytics Event model - Track user events and interactions
model AnalyticsEvent {
  id         String   @id @default(cuid())
  userId     String?
  eventName  String // e.g., 'page_view', 'kaiwa_session_start', etc.
  properties Json? // Event-specific properties
  timestamp  DateTime @default(now())
  userAgent  String?
  ip         String?
  url        String?
  referrer   String?

  user User? @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([eventName])
  @@index([timestamp])
}

// Subscription model - User subscription and credit tracking
model Subscription {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  tier   SubscriptionTier   @default(FREE)
  status SubscriptionStatus @default(ACTIVE)

  // Billing
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime

  // Credits
  creditsTotal     Int @default(0)
  creditsUsed      Int @default(0)
  creditsRemaining Int @default(0)

  // Trial tracking
  trialStartDate   DateTime?
  trialEndDate     DateTime?
  trialCreditsUsed Int       @default(0)
  trialDailyUsed   Int       @default(0)
  trialDailyReset  DateTime?

  // Character limits
  customCharactersUsed Int @default(0)

  // Scheduled tier change (for downgrades)
  scheduledTier        SubscriptionTier?
  scheduledTierStartAt DateTime?
  scheduledDurationMonths Int?

  // Metadata
  paymentCustomerId  String?
  paymentRecurringId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tier])
  @@index([status])
  @@index([scheduledTierStartAt])
}

// CreditTransaction model - Track all credit movements
model CreditTransaction {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  type    CreditTransactionType
  amount  Int // Positive = add, Negative = deduct
  balance Int // Balance after transaction

  // Usage details
  usageType    UsageType?
  durationSecs Int? // For voice/realtime

  // Reference
  referenceId   String? // Conversation ID, etc.
  referenceType String?

  description String?
  metadata    Json?

  createdAt DateTime @default(now())

  @@index([userId, createdAt])
  @@index([type, createdAt])
}

// Voucher model - Discount codes and promotions
model Voucher {
  id String @id @default(cuid())

  // Voucher details
  code        String  @unique
  name        String
  description String?

  // Type and value
  type  VoucherType
  value Int // Percentage, amount, or credits

  // Constraints
  maxUses     Int? // Null = unlimited
  usesPerUser Int  @default(1)
  currentUses Int  @default(0)

  // Validity
  startDate DateTime @default(now())
  endDate   DateTime?
  isActive  Boolean  @default(true)

  // Eligibility
  newUsersOnly    Boolean            @default(false)
  applicableTiers SubscriptionTier[]
  minMonths       Int? // Min subscription months required

  // Stacking
  isStackable Boolean @default(false)
  isExclusive Boolean @default(false)

  // Metadata
  createdBy String? // Admin userId
  metadata  Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  redemptions VoucherRedemption[]

  @@index([code])
  @@index([isActive, endDate])
}

// VoucherRedemption model - Track voucher usage
model VoucherRedemption {
  id String @id @default(cuid())

  voucherId String
  voucher   Voucher @relation(fields: [voucherId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Applied to
  subscriptionId String?

  // Discount details
  discountType   VoucherType
  discountValue  Int
  originalAmount Int? // Original price in Rupiah
  finalAmount    Int? // After discount

  // Status
  status RedemptionStatus @default(APPLIED)

  createdAt DateTime @default(now())

  @@unique([voucherId, userId]) // One redemption per user per voucher
  @@index([userId])
  @@index([voucherId])
}

// SubscriptionTierConfig model - Configurable pricing for subscription tiers
model SubscriptionTierConfig {
  id           String           @id @default(cuid())
  name         SubscriptionTier @unique
  priceMonthly Int              // Base price in Rupiah (harga dasar bulanan)
  features     String[]         // feature list
  isActive     Boolean          @default(true)
  credits      Int              @default(0) // Monthly credits allocation

  // Duration discount percentages (0-100)
  discount3Months  Int @default(10)  // Diskon 3 bulan (default 10%)
  discount6Months  Int @default(20)  // Diskon 6 bulan (default 20%)
  discount12Months Int @default(30)  // Diskon 12 bulan (default 30%)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([name])
  @@index([isActive])
}

// Enums for Subscription System
enum SubscriptionTier {
  FREE
  BASIC
  PRO
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELED
  EXPIRED
}

enum CreditTransactionType {
  GRANT // Monthly credit allocation
  TRIAL_GRANT // Trial credits
  USAGE // Credit deduction
  REFUND // Credit refund
  ADJUSTMENT // Manual adjustment
  BONUS // Promotional credits
}

enum UsageType {
  VOICE_STANDARD
  REALTIME
  TEXT_CHAT
}

enum VoucherType {
  PERCENTAGE // Discount percentage
  FIXED_AMOUNT // Fixed Rupiah discount
  BONUS_CREDITS // Extra credits
  TRIAL_EXTENSION // Extend trial days
  TIER_UPGRADE // Temporary tier upgrade
}

enum RedemptionStatus {
  APPLIED // Successfully applied
  EXPIRED // Voucher expired before use
  REVOKED // Manually revoked
}

// Payment System Models
model PendingPayment {
  id        String   @id @default(cuid())

  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Invoice details
  externalId    String   @unique
  invoiceId     String   @unique
  invoiceUrl    String

  // Subscription details
  tier          SubscriptionTier
  durationMonths Int
  amount        Int      // Amount in IDR

  // Status
  status        PaymentStatus @default(PENDING)

  // Payment details
  paidAt        DateTime?
  paymentMethod String?
  paymentChannel String?

  // Metadata
  metadata      Json?
  expiresAt     DateTime

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([status])
  @@index([externalId])
}

model MockInvoice {
  id        String   @id @default(cuid())

  invoiceId  String   @unique
  externalId String   @unique
  data       Json

  createdAt DateTime @default(now())

  @@index([invoiceId])
  @@index([externalId])
}

enum PaymentStatus {
  PENDING
  PAID
  EXPIRED
  FAILED
  REFUNDED
}

// Notification model - In-app notifications for users
model Notification {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  type    NotificationType
  title   String
  message String           @db.Text

  // Action
  actionUrl String?
  actionLabel String?

  // Status
  isRead    Boolean  @default(false)
  readAt    DateTime?

  // Metadata
  metadata  Json?

  createdAt DateTime @default(now())

  @@index([userId, isRead])
  @@index([userId, createdAt])
  @@index([type])
}

enum NotificationType {
  // Credit notifications
  CREDITS_80_PERCENT
  CREDITS_95_PERCENT
  CREDITS_DEPLETED
  CREDITS_RENEWED

  // Trial notifications
  TRIAL_STARTED
  TRIAL_ENDING_3_DAYS
  TRIAL_ENDING_1_DAY
  TRIAL_ENDED

  // Payment notifications
  PAYMENT_SUCCESS
  PAYMENT_FAILED
  PAYMENT_EXPIRED

  // Subscription renewal notifications
  SUBSCRIPTION_EXPIRING_3_DAYS
  SUBSCRIPTION_EXPIRING_1_DAY
  SUBSCRIPTION_EXPIRED

  // System notifications
  SYSTEM_ANNOUNCEMENT
  FEATURE_UPDATE
}

// Dictionary Entry model - JMDict vocabulary data for in-chat lookup
model DictionaryEntry {
  id            String   @id @default(cuid())
  entryId       Int      @unique // JMdict ent_seq

  // Readings
  kanji         String[] // Array of kanji writings
  readings      String[] // Array of kana readings

  // Meanings
  meaningsEn    String[] // English meanings (from JMDict)
  meaningsId    String[] // Indonesian (from static mapping)

  // Part of speech
  partsOfSpeech String[] // noun, verb, adj-i, etc.

  // JLPT Level (if available)
  jlptLevel     String?  // N5, N4, N3, N2, N1

  // Frequency/Priority
  priority      Int      @default(0) // Higher = more common

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([kanji])
  @@index([readings])
  @@index([jlptLevel])
  @@index([priority])
}

// ExtensionToken model - Authentication tokens for browser extensions (Gengo Reader)
model ExtensionToken {
  id        String   @id @default(cuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token     String   @unique // SHA-256 hashed token
  expiresAt DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([token])
  @@index([expiresAt])
}

// TrialHistory model - Track trial usage to prevent abuse
// When a user registers, we record their email. If they delete account
// and re-register with same email, we can deny trial.
model TrialHistory {
  id        String   @id @default(cuid())

  // User relation (optional - user may have deleted account)
  userId    String?  @unique
  user      User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  // Email is the primary identifier for anti-abuse
  email     String   @unique

  // Trial tracking
  trialStartedAt    DateTime
  trialEndedAt      DateTime?
  trialCreditsUsed  Int       @default(0)

  // Status
  hasUsedTrial      Boolean   @default(true)
  wasUpgraded       Boolean   @default(false) // User upgraded to paid at some point

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
  @@index([userId])
}
