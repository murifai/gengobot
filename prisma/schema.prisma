// Prisma schema for Gengotalk - Task-Based Japanese Learning App
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Task model - Primary feature for structured learning
model Task {
  id                 String   @id @default(cuid())
  title              String
  description        String   @db.Text
  category           String // Restaurant, Shopping, Travel, etc.
  subcategoryId      String? // Reference to TaskSubcategory
  difficulty         String // N1-N5 JLPT levels
  scenario             String @db.Text
  learningObjectives   Json // Array of learning goals
  conversationExample  String @db.Text // Example conversation dialog (T: teacher, G: student)
  estimatedDuration    Int // Minutes
  maxMessages        Int      @default(30) // Maximum messages per attempt
  isActive           Boolean  @default(true)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  createdBy          String? // Admin who created the task
  usageCount         Int      @default(0)
  averageScore       Float? // Average completion score

  characterId   String?
  character     Character?       @relation(fields: [characterId], references: [id])
  subcategory   TaskSubcategory? @relation(fields: [subcategoryId], references: [id])
  conversations Conversation[]
  taskAttempts  TaskAttempt[]
  studyDecks    TaskDeck[]

  @@index([category])
  @@index([subcategoryId])
  @@index([difficulty])
  @@index([isActive])
}

// TaskDeck model - Join table for Task-Deck many-to-many relationship
model TaskDeck {
  id        String   @id @default(cuid())
  taskId    String
  deckId    String
  order     Int      @default(0) // Display order for multiple decks
  createdAt DateTime @default(now())

  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  deck Deck @relation(fields: [deckId], references: [id], onDelete: Cascade)

  @@unique([taskId, deckId])
  @@index([taskId])
  @@index([deckId])
}

// TaskAttempt model - Tracks user progress on tasks
model TaskAttempt {
  id        String    @id @default(cuid())
  userId    String
  taskId    String
  startTime DateTime  @default(now())
  endTime   DateTime?

  // Simplified Feedback System
  feedback                  String?  @db.Text // JSON: SimplifiedAssessment
  conversationHistory       Json                // { messages: [...] }
  isCompleted               Boolean  @default(false)
  retryCount                Int      @default(0)

  // Objective Tracking
  objectiveCompletionStatus Json?               // ObjectiveTracking[]
  totalMessages             Int      @default(0)
  completionDuration        Int?                // seconds
  completionSuggestedAt     DateTime?

  user User @relation(fields: [userId], references: [id])
  task Task @relation(fields: [taskId], references: [id])

  @@index([userId])
  @@index([taskId])
  @@index([isCompleted])
}

// TaskCategory model - Main categories for tasks
model TaskCategory {
  id        String   @id @default(cuid())
  name      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  subcategories TaskSubcategory[]
}

// TaskSubcategory model - Subcategories for tasks (Jalan-jalan, Keseharian, Pekerjaan)
model TaskSubcategory {
  id         String   @id @default(cuid())
  name       String
  categoryId String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  category TaskCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  tasks    Task[]

  @@unique([name, categoryId])
  @@index([categoryId])
}

// User model - Student and admin accounts
model User {
  id                      String    @id @default(cuid())
  email                   String    @unique
  emailVerified           DateTime?
  name                    String?
  password                String? // Hashed password for credentials auth
  image                   String?
  proficiency             String    @default("N5") // N1-N5 JLPT levels
  isAdmin                 Boolean   @default(false)
  preferredTaskCategories Json? // Array of preferred task types
  completedTasks          Json? // Array of completed task IDs
  currentTaskId           String? // Currently active task
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt

  accounts           Account[]
  sessions           Session[]
  characters         Character[]
  conversations      Conversation[]
  taskAttempts       TaskAttempt[]
  adminLogs          AdminLog[]
  decks              Deck[]
  studySessions      StudySession[]
  freeConversations  FreeConversation[]

  @@index([email])
  @@index([isAdmin])
}

// NextAuth Account model
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

// NextAuth Session model
model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// NextAuth Verification Token model (for magic link auth)
model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// Email Verification Token model (for email verification)
model EmailVerificationToken {
  id         String   @id @default(cuid())
  email      String
  token      String   @unique
  expires    DateTime
  createdAt  DateTime @default(now())
  verifiedAt DateTime?

  @@index([email])
  @@index([token])
}

// Password Reset Token model (for password reset)
model PasswordResetToken {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expires   DateTime
  createdAt DateTime @default(now())
  usedAt    DateTime?

  @@index([email])
  @@index([token])
}

// Character model - For task-based and free-chat scenarios
model Character {
  id               String  @id @default(cuid())
  name             String
  description      String? @db.Text
  voice            String? // OpenAI TTS voice (alloy, echo, fable, onyx, nova, shimmer)
  personality      Json // Personality traits
  speakingStyle    String? @db.Text
  taskSpecific     Boolean @default(false) // Whether designed for specific tasks
  assignedTasks    Json? // Array of task IDs where this character is used
  relationshipType String? // For free chat (secondary feature)
  isUserCreated    Boolean @default(true)

  userId             String?
  user               User?               @relation(fields: [userId], references: [id])
  conversations      Conversation[]
  tasks              Task[]
  freeConversations  FreeConversation[]

  @@index([userId])
  @@index([taskSpecific])
}

// Conversation model - Stores chat histories
model Conversation {
  id          String   @id @default(cuid())
  type        String // "task-based" or "free-chat"
  messages    Json
  assessment  Json?
  taskId      String? // Associated task (if task-based)
  characterId String? // Character involved
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  userId    String
  user      User       @relation(fields: [userId], references: [id])
  character Character? @relation(fields: [characterId], references: [id])
  task      Task?      @relation(fields: [taskId], references: [id])

  @@index([userId])
  @@index([type])
  @@index([taskId])
}

// AdminLog model - Track admin actions for auditing
model AdminLog {
  id         String   @id @default(cuid())
  adminId    String
  actionType String // create_task, edit_task, delete_task, etc.
  entityType String // task, character, user, etc.
  entityId   String?
  details    Json?
  createdAt  DateTime @default(now())

  admin User @relation(fields: [adminId], references: [id])

  @@index([adminId])
  @@index([actionType])
  @@index([createdAt])
}

// Deck model - Collections of flashcards for study
model Deck {
  id          String  @id @default(cuid())
  name        String
  description String? @db.Text
  isPublic    Boolean @default(false)
  category    String? // Kanji, Vocabulary, Grammar, Mixed, etc.
  difficulty  String? // N1-N5 JLPT levels

  // Analytics
  totalCards   Int    @default(0)
  studyCount   Int    @default(0) // Number of times studied
  averageScore Float? // Average performance across all studies

  // Ownership
  createdBy String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  creator       User           @relation(fields: [createdBy], references: [id], onDelete: Cascade)
  flashcards    Flashcard[]
  studySessions StudySession[]
  taskDecks     TaskDeck[]

  @@index([createdBy])
  @@index([category])
  @@index([difficulty])
  @@index([isActive])
  @@index([isPublic])
}

// Flashcard model - Individual study cards with spaced repetition
model Flashcard {
  id     String @id @default(cuid())
  deckId String

  // Card type determines which fields are used
  cardType String // "kanji", "vocabulary", "grammar"

  // Kanji Card Fields
  kanji        String?
  kanjiMeaning String? @db.Text
  onyomi       String?
  kunyomi      String?

  // Vocabulary Card Fields
  word         String?
  wordMeaning  String? @db.Text
  reading      String? // Furigana/pronunciation
  partOfSpeech String? // Noun, Verb, Adjective, etc.

  // Grammar Card Fields
  grammarPoint   String? @db.Text
  grammarMeaning String? @db.Text
  usageNote      String? @db.Text

  // Common Fields (all card types)
  exampleSentence    String? @db.Text
  exampleTranslation String? @db.Text
  notes              String? @db.Text
  tags               Json? // Array of tags for filtering

  // Spaced Repetition Algorithm (SM-2)
  easeFactor     Float     @default(2.5) // Difficulty rating
  interval       Int       @default(0) // Days until next review
  repetitions    Int       @default(0) // Number of successful reviews
  nextReviewDate DateTime? // When to review next
  lastReviewedAt DateTime? // Last review timestamp

  // Order and status
  position  Int      @default(0) // Order within deck
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  deck          Deck              @relation(fields: [deckId], references: [id], onDelete: Cascade)
  reviewHistory FlashcardReview[]

  @@index([deckId])
  @@index([cardType])
  @@index([nextReviewDate])
  @@index([isActive])
}

// FlashcardReview model - Track individual card review history
model FlashcardReview {
  id          String @id @default(cuid())
  flashcardId String
  sessionId   String

  // Review outcome
  rating       String // "belum_hafal", "hafal"
  responseTime Int? // Milliseconds

  // Spaced repetition data at time of review
  easeFactor Float
  interval   Int

  reviewedAt DateTime @default(now())

  flashcard Flashcard    @relation(fields: [flashcardId], references: [id], onDelete: Cascade)
  session   StudySession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([flashcardId])
  @@index([sessionId])
  @@index([reviewedAt])
}

// StudySession model - Track study session performance
model StudySession {
  id     String @id @default(cuid())
  userId String
  deckId String

  // Session metrics
  cardsReviewed       Int    @default(0)
  cardsCorrect        Int    @default(0)
  averageResponseTime Float? // Milliseconds

  // Session breakdown by rating
  belumHafalCount Int @default(0)
  hafalCount      Int @default(0)

  startTime   DateTime  @default(now())
  endTime     DateTime?
  isCompleted Boolean   @default(false)

  user    User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  deck    Deck              @relation(fields: [deckId], references: [id], onDelete: Cascade)
  reviews FlashcardReview[]

  @@index([userId])
  @@index([deckId])
  @@index([startTime])
  @@index([isCompleted])
}

// FreeConversation model - Free conversation sessions (Kaiwa Bebas)
model FreeConversation {
  id                  String   @id @default(cuid())
  userId              String
  characterId         String? // Character for this conversation (optional for migration)
  startTime           String // ISO DateTime as string
  endTime             String? // ISO DateTime as string
  conversationHistory Json // { messages: [], startedAt: string }
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  character Character? @relation(fields: [characterId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([characterId])
  @@index([createdAt])
}
